(function(b){var c={};function a(i,e,k,j,d){var l,g,f,h;g=google.gears.factory.create("beta.canvas");g.decode(i);h=Math.min(e/g.width,k/g.height);if(h<1){e=Math.round(g.width*h);k=Math.round(g.height*h)}else{e=g.width;k=g.height}g.resize(e,k);return g.encode(d,{quality:j/100})}b.runtimes.Gears=b.addRuntime("gears",{init:function(g,i){var h;if(!window.google||!google.gears){return i({success:false})}try{h=google.gears.factory.create("beta.desktop")}catch(f){return i({success:false})}function d(k){var j,e,l=[],m;for(e=0;e<k.length;e++){j=k[e];m=b.guid();c[m]=j.blob;l.push(new b.File(m,j.name,j.blob.length))}g.trigger("FilesAdded",l)}g.bind("PostInit",function(){var j=g.settings,e=document.getElementById(j.drop_element);if(e){b.addEvent(e,"dragover",function(k){k.preventDefault()});b.addEvent(e,"drop",function(l){var k=h.getDragData(l,"application/x-gears-files");if(k){d(k.files)}l.preventDefault()});e=0}b.addEvent(document.getElementById(j.browse_button),"click",function(o){var n=[],l,k,m;o.preventDefault();for(l=0;l<j.filters.length;l++){m=j.filters[l].extensions.split(",");for(k=0;k<m.length;k++){n.push("."+m[k])}}h.openFiles(d,{singleFile:!j.multi_selection,filter:n})})});g.bind("UploadFile",function(e,n){var m=0,p,o,l=0,k=e.settings.resize;o=e.settings.chunk_size;p=Math.ceil(n.size/o);if(k&&/\.(png|jpg|jpeg)$/i.test(n.name)){c[n.id]=a(c[n.id],k.width,k.height,k.quality||90,/\.png$/i.test(n.name)?"image/png":"image/jpeg")}n.size=c[n.id].length;function j(){var t,u,r=e.settings.multipart,q=0;function s(w){var v,A="----pluploadboundary"+b.guid(),y="--",z="\r\n",x;if(r){t.setRequestHeader("Content-Type","multipart/form-data; boundary="+A);v=google.gears.factory.create("beta.blobbuilder");b.each(e.settings.multipart_params,function(C,B){v.append(y+A+z+'Content-Disposition: form-data; name="'+B+'"'+z+z);v.append(C+z)});v.append(y+A+z+'Content-Disposition: form-data; name="file"; filename="'+n.name+'"'+z+"Content-Type: application/octet-stream"+z+z);v.append(w);v.append(z+y+A+y+z);x=v.getAsBlob();q=x.length-w.length;w=x}t.send(w)}if(n.status==b.DONE||n.status==b.FAILED||e.state==b.STOPPED){return}u=Math.min(o,n.size-(m*o));t=google.gears.factory.create("beta.httprequest");t.open("POST",b.buildUrl(e.settings.url,{name:n.target_name||n.name,chunk:m,chunks:p}));if(!r){t.setRequestHeader("Content-Disposition",'attachment; filename="'+n.name+'"');t.setRequestHeader("Content-Type","application/octet-stream")}t.upload.onprogress=function(v){n.loaded=l+v.loaded-q;e.trigger("UploadProgress",n)};t.onreadystatechange=function(){var v;if(t.readyState==4){if(t.status==200){v={file:n,chunk:m,chunks:p,response:t.responseText};e.trigger("ChunkUploaded",v);if(v.cancelled){n.status=b.FAILED;return}l+=u;if(++m>=p){n.status=b.DONE;e.trigger("FileUploaded",n,{response:t.responseText,status:t.status})}else{j()}}else{e.trigger("UploadChunkError",{file:n,chunk:m,chunks:p,error:"Status: "+t.status})}}};if(m<p){s(c[n.id].slice(m*o,u))}}j()});g.features={dragdrop:true,jpgresize:true,pngresize:true,chunks:true};i({success:true})}})})(plupload);